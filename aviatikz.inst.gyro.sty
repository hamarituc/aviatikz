%
% aviatikz.inst.gyro.sty
% Copyright (C) 2020 Mario Haustein
%
% This work may be distributed and/or modified under the conditions of the
% LaTeX Project Public License, either version 1.3 of this license or (at your
% option) any later version. The latest version of this license is in the file
%
%   http://www.latex-project.org/lppl.txt
%
% This file is part of the "aviatikz bundle" (The Work in LPPL) and all files
% in that bundle must be distributed together.
%


%
% Gyrokompass
%

\pgfmathsetmacro{\avia@inst@gyro@scale@outrad}{\avia@inst@face@rad}		% Au√üenradius Kursskala
\pgfmathsetmacro{\avia@inst@gyro@scale@mainrad}{\avia@inst@face@rad - 0.5}	% Innenadius Skalenstrich mit Bezeichner
\pgfmathsetmacro{\avia@inst@gyro@scale@majorrad}{\avia@inst@face@rad - 0.5}	% Innenradius Skalenstrich ohne Bezeichner
\pgfmathsetmacro{\avia@inst@gyro@scale@minorrad}{\avia@inst@face@rad - 0.3}	% Innenradius Teilstrich
\pgfmathsetmacro{\avia@inst@gyro@scale@numrad}{\avia@inst@face@rad - 0.9}	% Beschriftungsradius Kursskala
\pgfmathsetmacro{\avia@inst@gyro@markerinrad}{\avia@inst@face@rad - 0.25}	% Innenradius Kursmarker
\pgfmathsetmacro{\avia@inst@gyro@markerthick}{0.1}				% Halbbreite Kursmarker


% Hintergrund
\newcommand{\aviainst@gyro@face}
{
  \path [/avia/inst/gyro/scale/background] (0, 0) circle (\avia@inst@hole@rad);
}


% Kursskala
\let\aviainst@gyro@scale@label\aviainst@crs@letter

\newcommand{\aviainst@gyro@scale}
{
  \begingroup

  \foreach \i in {0,3,...,33}
  {
    \pgfmathsetmacro{\angle}{-10 * \i + 90}
    \pgfmathsetmacro{\anglelabel}{\angle - 90}
    \node [/avia/inst/gyro/scale/number] at
      (\angle:\avia@inst@gyro@scale@numrad) [rotate=\anglelabel] {\aviainst@gyro@scale@label{\i}};
  }

  \foreach \i in {0,10,...,350}
  {
    \pgfmathsetmacro{\angle}{\i + 90}
    \pgfmathtruncatemacro{\modulo}{mod(\i, 30)}
    \ifnum\modulo=0
      \path [/avia/inst/gyro/scale/maintick]
        (\angle:\avia@inst@gyro@scale@outrad) -- (\angle:\avia@inst@gyro@scale@mainrad);
    \else
      \path [/avia/inst/gyro/scale/majortick]
        (\angle:\avia@inst@gyro@scale@outrad) -- (\angle:\avia@inst@gyro@scale@majorrad);
    \fi
  }

  \foreach \i in {5,15,...,355}
  {
    \pgfmathsetmacro{\angle}{\i + 90}
    \path [/avia/inst/gyro/scale/minortick]
      (\angle:\avia@inst@gyro@scale@outrad) -- (\angle:\avia@inst@gyro@scale@minorrad);
  }

  \endgroup
}

\pgfkeys{/avia/inst/gyro/scale/background/.style={fill=black!80}}
\pgfkeys{/avia/inst/gyro/scale/maintick/.style={draw=white,line width=2.0pt}}
\pgfkeys{/avia/inst/gyro/scale/majortick/.style={draw=white,line width=1.0pt}}
\pgfkeys{/avia/inst/gyro/scale/minortick/.style={draw=white,line width=1.0pt}}
\pgfkeys{/avia/inst/gyro/scale/number/.style={text=white,font={\pgfkeys{/avia/inst/font}\fontsize{16}{16}\selectfont}}}

\pgfkeys{/avia/inst/gyro/scale/style/.is choice}
\pgfkeys{/avia/inst/gyro/scale/style/.value required}
\pgfkeys{/avia/inst/gyro/scale/style/number/.code={\let\aviainst@gyro@scale@label\aviainst@crs@number}}
\pgfkeys{/avia/inst/gyro/scale/style/letter/.code={\let\aviainst@gyro@scale@label\aviainst@crs@letter}}
\pgfkeys{/avia/inst/gyro/scale/style=letter}


% Kursmarker
\newcommand{\aviainst@gyro@marker}
{
  \begingroup
  \foreach \i in {45,90,...,315}
  {
    \begin{scope}[rotate=\i]
    \path [/avia/inst/gyro/marker]
      ( 0.0, \avia@inst@gyro@markerinrad) --
      (-\avia@inst@gyro@markerthick, \avia@inst@face@rad) --
      ( \avia@inst@gyro@markerthick, \avia@inst@face@rad) --
      cycle;
    \end{scope}
  }
  \endgroup
}

\pgfkeys{/avia/inst/gyro/marker/.style={fill=avia@inst@markerorange,draw=avia@inst@markerorange!40!black,thin}}


% Flugzeugsymbol
\newcommand{\aviainst@gyro@acft}
{
  \path [/avia/inst/gyro/acft/symbol]
    ( 0.0,  2.2)
    .. controls +(-0.1, -0.2) and +( 0.0,  0.5) ..
    (-0.3,  0.8) -- (-1.6, -0.1)
    .. controls +(-0.1, -0.1) and +( 0.0,  0.1) ..
    (-1.7, -0.5) -- (-0.3,  0.0) -- (-0.2, -1.1) -- (-0.6, -1.5)
    .. controls +(-0.1, -0.1) and +( 0.0,  0.1) ..
    (-0.7, -1.8) -- (-0.1, -1.5) --
    ( 0.0, -1.7) --
    ( 0.1, -1.5) -- ( 0.7, -1.8)
    .. controls +( 0.0,  0.1) and +( 0.1, -0.1) ..
    ( 0.6, -1.5) -- ( 0.2, -1.1) -- ( 0.3,  0.0) -- ( 1.7, -0.5)
    .. controls +( 0.0,  0.1) and +( 0.1, -0.1) ..
    ( 1.6, -0.1) -- ( 0.3,  0.8)
    .. controls +( 0.0,  0.5) and +( 0.1, -0.2) ..
    cycle
    ( 0.0,  2.2) -- ( 0.0, \avia@inst@gyro@scale@minorrad);
}

\pgfkeys{/avia/inst/gyro/acft/border/.style={draw=black,line cap=rect,line width=2.5pt}}
\pgfkeys{/avia/inst/gyro/acft/symbol/.style={draw=avia@inst@markerorange,line cap=rect,line width=1.5pt}}


% Gyro-Knopf
\newcommand{\aviainst@gyro@gyroknob}
{
  \begingroup
  \aviainst@knob
  \pgfmathsetmacro{\ring}{\avia@inst@knob@ring - 0.15}

  \node [/avia/inst/gyro/knob/gyro/label] at (0, 0) {PUSH};
  \path [/avia/inst/gyro/knob/gyro/arrow,draw=white,Latex-]
    (150:\ring) -- (135:\ring);
  \path [/avia/inst/gyro/knob/gyro/arrow,draw=white]
    (135:\ring) arc [start angle=135,end angle=45,radius=\ring] ( 45:\ring);
  \path [/avia/inst/gyro/knob/gyro/arrow,draw=white,-Latex]
    ( 45:\ring) -- ( 30:\ring);
  \endgroup
}

\pgfkeys{/avia/inst/gyro/knob/gyro/label/.style={text=white,font={\pgfkeys{/avia/inst/font}\fontsize{10}{10}\selectfont\bfseries}}}
\pgfkeys{/avia/inst/gyro/knob/gyro/arrow/.style={draw=white}}


% Kurswahl
\newcommand{\aviainst@gyro@hdgbug}
{
  \begin{scope}[shift={(0, \avia@inst@face@rad)}]
  \path [/avia/inst/gyro/hdgbug/style]
    (-0.03,  0.00) -- (-0.03, -0.30) -- (-0.10, -0.30) -- (-0.20, -0.15) -- (-0.20,  0.0) -- cycle;
  \path [/avia/inst/gyro/hdgbug/style]
    ( 0.03,  0.00) -- ( 0.03, -0.30) -- ( 0.10, -0.30) -- ( 0.20, -0.15) -- ( 0.20,  0.0) -- cycle;
  \end{scope}
}

\newif\ifavia@inst@gyro@hashdgbug
\pgfkeys{/avia/inst/gyro/hashdgbug/.is if=avia@inst@gyro@hashdgbug}
\pgfkeys{/avia/inst/gyro/hashdgbug=false}

\pgfkeys{/avia/inst/gyro/hdgbug/style/.style={fill=avia@inst@markerorange,draw=avia@inst@markerorange!40!black,thin}}


% HDG-Knopf
\newcommand{\aviainst@gyro@hdgknob}
{
  \begingroup
  \aviainst@knob
  \node [/avia/inst/gyro/knob/hdg] at (0, 0) {HDG};
  \endgroup
}

\pgfkeys{/avia/inst/gyro/knob/hdg/.style={text=avia@inst@markerorange,font={\pgfkeys{/avia/inst/font}\fontsize{12}{12}\selectfont\bfseries}}}


% Instrument zeichnen.
\newcommand{\aviainstgyro}[1][]
{
  \begingroup

  \pgfkeys{/avia/inst/gyro/.cd,#1}

  \pgfkeysgetvalue{/avia/inst/gyro/hdg}{\hdg}
  \pgfkeysgetvalue{/avia/inst/gyro/hdgbug}{\hdgbug}
  \pgfmathsetmacro{\hdgbug}{-\hdgbug}

  \aviainst@frame
  \aviainst@gyro@face

  \begin{scope}[rotate=\hdg,transform shape]
  \aviainst@gyro@scale
    \ifavia@inst@gyro@hashdgbug
    \begin{scope}[rotate=\hdgbug,transform shape]
    \aviainst@gyro@hdgbug
    \end{scope}
    \fi
  \end{scope}

  \aviainst@gyro@marker
  \aviainst@gyro@acft

  \aviainst@border@circle

  % Gyro-Knopf
  \begingroup
  \pgfmathsetmacro{\knobcoord}{\avia@inst@mount@dist / sqrt(2)}
  \begin{scope}[shift={(-\knobcoord,-\knobcoord)},transform shape]
  \aviainst@gyro@gyroknob
  \end{scope}
  \endgroup

  \ifavia@inst@gyro@hashdgbug
  \begingroup
  \pgfmathsetmacro{\knobcoord}{\avia@inst@mount@dist / sqrt(2)}
  \begin{scope}[shift={(\knobcoord,-\knobcoord)},rotate=\hdgbug,transform shape]
  \aviainst@gyro@hdgknob
  \end{scope}
  \endgroup
  \fi

  \endgroup
}


% Einstellungen
\pgfkeys{/avia/inst/gyro/hdg/.initial=0}
\pgfkeys{/avia/inst/gyro/hdg/.value required}

\pgfkeys{/avia/inst/gyro/hdgbug/.initial=0}
\pgfkeys{/avia/inst/gyro/hdgbug/.value required}
